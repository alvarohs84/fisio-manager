{% extends "base.html" %}

{% block content %}
<div class="container py-3">
  <header>
    <div class="pricing-header p-3 pb-md-4 mx-auto text-center">
      <h1 class="display-4 fw-normal">Planos e Preços</h1>
      <p class="fs-5 text-muted">Escolha o plano que melhor se adapta à sua clínica.</p>
    </div>
  </header>

  <main>
    <div class="row row-cols-1 row-cols-md-2 mb-3 text-center justify-content-center">
      <div class="col">
        <div class="card mb-4 rounded-3 shadow-sm">
          <div class="card-header py-3"><h4 class="my-0 fw-normal">Plano Mensal</h4></div>
          <div class="card-body">
            <h1 class="card-title">R$59<small class="text-muted fw-light">,90/mês</small></h1>
            <ul class="list-unstyled mt-3 mb-4">
              <li>Todas as funcionalidades incluídas</li>
              <li>Suporte por e-mail</li>
            </ul>
            <button type="button" class="w-100 btn btn-lg btn-outline-primary subscribe-btn" data-plan="mensal">Assinar Plano Mensal</button>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card mb-4 rounded-3 shadow-sm border-primary">
          <div class="card-header py-3 text-white bg-primary border-primary"><h4 class="my-0 fw-normal">Plano Anual</h4></div>
          <div class="card-body">
            <h1 class="card-title">R$599<small class="text-muted fw-light">,00/ano</small></h1>
            <ul class="list-unstyled mt-3 mb-4">
              <li><strong>Desconto de 2 meses!</strong></li>
              <li>Todas as funcionalidades incluídas</li>
              <li>Suporte prioritário</li>
            </ul>
            <button type="button" class="w-100 btn btn-lg btn-primary subscribe-btn" data-plan="anual">Assinar Plano Anual</button>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
{% endblock %}

{% block scripts %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const stripe = Stripe('{{ config.STRIPE_PUBLISHABLE_KEY }}');
        const subscribeButtons = document.querySelectorAll('.subscribe-btn');

        subscribeButtons.forEach(button => {
            button.addEventListener('click', function () {
                const planType = this.getAttribute('data-plan');

                // Desativa o botão para evitar múltiplos cliques
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> A redirecionar...';

                fetch('/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ plan_type: planType })
                })
                .then(response => {
                    // Primeiro, verificamos se a resposta da nossa API foi bem-sucedida
                    if (!response.ok) {
                        // Se não foi (ex: erro 403, 500), lemos o erro e rejeitamos a promessa
                        return response.json().then(err => Promise.reject(err));
                    }
                    return response.json();
                })
                .then(session => {
                    // Se a resposta foi OK e temos um sessionId, redirecionamos para o Stripe
                    if (session.sessionId) {
                        return stripe.redirectToCheckout({ sessionId: session.sessionId });
                    } else {
                        // Se a resposta foi OK mas não veio o sessionId, é um erro inesperado
                        throw new Error('ID da sessão de checkout não recebido.');
                    }
                })
                .catch(error => {
                    // Aqui apanhamos todos os erros, tanto da rede como os que rejeitámos
                    console.error('Erro ao criar sessão de checkout:', error);
                    alert('Ocorreu um erro: ' + (error.error || 'Não foi possível iniciar o pagamento. Tente novamente.'));
                    // Reativa o botão em caso de erro
                    button.disabled = false;
                    button.innerHTML = `Assinar Plano ${planType === 'mensal' ? 'Mensal' : 'Anual'}`;
                });
            });
        });
    });
</script>
{% endblock %}
```