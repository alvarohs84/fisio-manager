{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Dashboard</h1>
    <span class="text-muted">Mês de Referência: {{ today.strftime('%B de %Y')|capitalize }}</span>
</div>

<!-- Linha de Gráficos de Perfil de Pacientes -->
<div class="row">
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title text-center">Distribuição por Gênero</h5>
                <canvas id="genderChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title text-center">Distribuição por Faixa Etária</h5>
                <canvas id="ageChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-12 col-lg-4 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title text-center">Pacientes por Especialidade</h5>
                <canvas id="specialtyChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Linha do Gráfico de Atendimentos -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title text-center">Top 10 Pacientes com Mais Atendimentos no Mês</h5>
                <canvas id="appointmentsChart"></canvas>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- DADOS VINDOS DO BACKEND ---
    const genderData = {{ gender_data|tojson }};
    const ageData = {{ age_data|tojson }};
    const specialtyData = {{ specialty_data|tojson }};
    const appointmentsData = {{ appointments_data|tojson }};

    // --- CONFIGURAÇÃO PADRÃO DOS GRÁFICOS ---
    const defaultOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    };

    // --- GRÁFICO DE GÊNERO (PIE) ---
    const genderCtx = document.getElementById('genderChart');
    if (genderCtx) {
        new Chart(genderCtx, {
            type: 'pie',
            data: {
                labels: Object.keys(genderData),
                datasets: [{
                    label: 'Pacientes',
                    data: Object.values(genderData),
                    backgroundColor: ['#0d6efd', '#dc3545', '#6c757d'],
                }]
            },
            options: defaultOptions
        });
    }

    // --- GRÁFICO DE FAIXA ETÁRIA (DOUGHNUT) ---
    const ageCtx = document.getElementById('ageChart');
    if (ageCtx) {
        new Chart(ageCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(ageData),
                datasets: [{
                    label: 'Pacientes',
                    data: Object.values(ageData),
                    backgroundColor: ['#0dcaf0', '#198754', '#ffc107', '#fd7e14'],
                }]
            },
            options: defaultOptions
        });
    }

    // --- GRÁFICO DE ESPECIALIDADES (POLAR AREA) ---
    const specialtyCtx = document.getElementById('specialtyChart');
    if (specialtyCtx) {
        new Chart(specialtyCtx, {
            type: 'polarArea',
            data: {
                labels: Object.keys(specialtyData),
                datasets: [{
                    label: 'Pacientes',
                    data: Object.values(specialtyData),
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(255, 205, 86, 0.7)',
                        'rgba(201, 203, 207, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)'
                    ],
                }]
            },
            options: defaultOptions
        });
    }

    // --- GRÁFICO DE ATENDIMENTOS (BAR) ---
    const appointmentsCtx = document.getElementById('appointmentsChart');
    if (appointmentsCtx) {
        new Chart(appointmentsCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(appointmentsData),
                datasets: [{
                    label: 'Nº de Atendimentos Concluídos no Mês',
                    data: Object.values(appointmentsData),
                    backgroundColor: 'rgba(0, 123, 255, 0.5)',
                    borderColor: 'rgba(0, 123, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y', // Deixa as barras na horizontal para melhor leitura
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1 // Garante que o eixo só mostre números inteiros
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
