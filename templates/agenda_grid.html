{% extends "base.html" %}

{% block styles %}
<style>
    /* ... (todos os estilos anteriores, sem alterações) ... */
    .fc-event-main-frame { display: flex; align-items: center; }
    .payment-icon { margin-left: 8px; font-size: 0.9em; padding: 2px 5px; border-radius: 4px; color: white; }
    .payment-balance-positive { background-color: #198754; }
    .payment-balance-negative { background-color: #dc3545; }
    .payment-balance-zero { background-color: #6c757d; }
    .fc-event.cancelled-event { background-color: #f8f9fa !important; border-color: #d3d3d3 !important; }
    .fc-event.cancelled-event .fc-event-title { text-decoration: line-through; color: #6c757d !important; }
    .fc-event.completed-event .fc-event-title { font-weight: bold; }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header"><h3>Agenda de Atendimentos</h3></div>
    <div class="card-body"><div id='calendar'></div></div>
</div>

<div class="modal fade" id="scheduleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="scheduleModalLabel">Novo Agendamento</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="scheduleForm"><input type="hidden" id="start_datetime"><div class="mb-3"><label for="patientSelect" class="form-label">Paciente</label><select class="form-select" id="patientSelect" required></select></div><div class="row"><div class="col-md-6 mb-3"><label for="locationInput" class="form-label">Local</label><input type="text" class="form-control" id="locationInput" value="Clínica"></div><div class="col-md-6 mb-3"><label for="priceInput" class="form-label">Preço da Sessão (R$)</label><input type="number" class="form-control" id="priceInput" placeholder="Ex: 150.00" step="0.01"></div></div><div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="isRecurringCheck"><label class="form-check-label" for="isRecurringCheck">Repetir atendimento</label></div><div id="recurrenceOptions" class="border p-3 rounded mb-3" style="display: none;"><div class="mb-3"><label class="form-label">Repetir nos dias:</label><div><div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="1" id="checkMon"><label for="checkMon">Seg</label></div><div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="2" id="checkTue"><label for="checkTue">Ter</label></div><div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="3" id="checkWed"><label for="checkWed">Qua</label></div><div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="4" id="checkThu"><label for="checkThu">Qui</label></div><div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="5" id="checkFri"><label for="checkFri">Sex</label></div><div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="6" id="checkSat"><label for="checkSat">Sáb</label></div></div></div><div class="mb-3"><label for="weeksRepeatInput" class="form-label">Por quantas semanas?</label><input type="number" class="form-control" id="weeksRepeatInput" value="4" min="1"></div></div><div class="mb-3"><label for="notesTextarea" class="form-label">Anotações</label><textarea class="form-control" id="notesTextarea" rows="2"></textarea></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button><button type="button" class="btn btn-primary" id="saveAppointmentBtn">Salvar</button></div></div></div>
</div>

<div class="modal fade" id="viewEventModal" tabindex="-1" aria-labelledby="viewEventModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewEventModalLabel">Detalhes do Agendamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editEventForm">
            <h5 id="viewPatientName"></h5>
            <fieldset id="general-fieldset" disabled>
                <div class="row">
                    <div class="col-md-7 mb-3">
                        <label for="viewEventDateInput" class="form-label">Data e Hora</label>
                        <input type="datetime-local" class="form-control" id="viewEventDateInput">
                    </div>
                    <div class="col-md-5 mb-3">
                        <label for="viewEventLocationInput" class="form-label">Local</label>
                        <input type="text" class="form-control" id="viewEventLocationInput">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="viewEventNotes" class="form-label">Anotações Gerais</label>
                    <textarea class="form-control" id="viewEventNotes" rows="2"></textarea>
                </div>
            </fieldset>
            <hr>
            <fieldset id="financialsFieldset">
                <h6>Financeiro da Sessão</h6>
                <div class="row">
                    <div class="col-6 mb-3">
                        <label for="viewEventPrice" class="form-label">Preço da Sessão (R$)</label>
                        <input type="number" class="form-control" id="viewEventPrice" step="0.01">
                    </div>
                    <div class="col-6 mb-3">
                        <label for="viewAmountPaid" class="form-label">Valor Pago (R$)</label>
                        <input type="number" class="form-control" id="viewAmountPaid" step="0.01">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="viewPaymentNotes" class="form-label">Anotações do Pagamento</label>
                    <textarea class="form-control" id="viewPaymentNotes" rows="2"></textarea>
                </div>
            </fieldset>
        </form>
      </div>
      <div class="modal-footer justify-content-between">
          <div>
              <button type="button" class="btn btn-outline-danger btn-sm" id="deleteAppointmentTriggerBtn" title="Apagar Permanentemente"><i class="bi bi-trash"></i> Apagar</button>
              <a href="#" id="viewGoToPatient" class="btn btn-outline-info btn-sm">Ver Prontuário</a>
          </div>
          <div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeViewBtn">Fechar</button>
            <button type="button" class="btn btn-outline-secondary" id="editAppointmentBtn">Editar</button>
            <button type="button" class="btn btn-primary" id="saveChangesBtn" style="display:none;">Salvar Alterações</button>
          </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}


{% block scripts %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- INICIALIZAÇÃO ---
    var scheduleModal = new bootstrap.Modal(document.getElementById('scheduleModal'));
    var viewEventModal = new bootstrap.Modal(document.getElementById('viewEventModal'));
    let currentEventId = null;

    // Função para alternar entre modo de visualização e edição
    function setViewMode(isEditMode) {
        document.getElementById('general-fieldset').disabled = !isEditMode;
        document.getElementById('financialsFieldset').disabled = !isEditMode;
        document.getElementById('editAppointmentBtn').style.display = isEditMode ? 'none' : 'inline-block';
        document.getElementById('saveChangesBtn').style.display = isEditMode ? 'inline-block' : 'none';
    }

    // --- CONFIGURAÇÃO DO CALENDÁRIO ---
    var calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        locale: 'pt-br',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
        initialView: 'timeGridWeek',
        events: '/api/appointments',
        selectable: true,
        
        // Clique para CRIAR (sem alterações)
        dateClick: function(info) {
            // ...
            scheduleModal.show();
        },

        // Clique para VER/EDITAR
        eventClick: function(info) {
            currentEventId = info.event.id;
            let props = info.event.extendedProps;
            let startDate = info.event.start;
            
            // Coloca o modal no modo de visualização por padrão
            setViewMode(false);

            // Preenche os campos do formulário (que agora são inputs)
            document.getElementById('viewPatientName').textContent = info.event.title;
            
            // Formata a data para o input datetime-local (YYYY-MM-DDTHH:mm)
            const localDateTime = new Date(startDate.getTime() - (startDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('viewEventDateInput').value = localDateTime;
            
            document.getElementById('viewEventLocationInput').value = props.location || '';
            document.getElementById('viewEventNotes').value = props.notes || '';
            document.getElementById('viewGoToPatient').href = `/patient/${props.patient_id}`;
            document.getElementById('viewEventPrice').value = props.session_price || '';
            document.getElementById('viewAmountPaid').value = props.amount_paid || '';
            document.getElementById('viewPaymentNotes').value = props.payment_notes || '';
            
            viewEventModal.show();
        }
    });
    calendar.render();

    // --- EVENT LISTENERS DOS BOTÕES ---

    // Botão EDITAR dentro do modal de visualização
    document.getElementById('editAppointmentBtn').addEventListener('click', function() {
        setViewMode(true);
    });
    
    // Botão SALVAR ALTERAÇÕES dentro do modal de visualização
    document.getElementById('saveChangesBtn').addEventListener('click', function() {
        const appointmentData = {
            start_time: new Date(document.getElementById('viewEventDateInput').value).toISOString(),
            location: document.getElementById('viewEventLocationInput').value,
            notes: document.getElementById('viewEventNotes').value,
            session_price: document.getElementById('viewEventPrice').value,
            amount_paid: document.getElementById('viewAmountPaid').value,
            payment_notes: document.getElementById('viewPaymentNotes').value,
        };

        fetch(`/api/appointment/${currentEventId}/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(appointmentData),
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                viewEventModal.hide();
                calendar.refetchEvents();
            } else {
                alert(`Erro ao salvar: ${data.message}`);
            }
        });
    });

    // ... (outros listeners de botões como 'saveAppointmentBtn' (novo agendamento), 'delete' e 'cancel' permanecem os mesmos) ...

});
</script>
{% endblock %}