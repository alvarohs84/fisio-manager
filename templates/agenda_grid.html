{% extends "base.html" %}

{% block styles %}
<style>
    /* Estilos para o ícone de pagamento no evento */
    .fc-event-main-frame { display: flex; align-items: center; }
    .payment-icon { margin-left: 8px; font-size: 0.9em; padding: 2px 5px; border-radius: 4px; color: white; }
    .payment-balance-positive { background-color: #198754; } /* Verde para crédito */
    .payment-balance-negative { background-color: #dc3545; } /* Vermelho para débito */
    .payment-balance-zero { background-color: #6c757d; } /* Cinza para zerado */

    /* Estilos do spinner e do formulário */
    .loading-spinner { display: none; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 10; }
    .modal-body.loading .loading-spinner { display: block; }
    .modal-body.loading .modal-form-content { opacity: 0.5; pointer-events: none; }
    
    /* Estilo para eventos cancelados */
    .fc-event.cancelled-event {
        background-color: #f8f9fa !important;
        border-color: #d3d3d3 !important;
    }
    .fc-event.cancelled-event .fc-event-title {
        text-decoration: line-through;
        color: #6c757d !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header"><h3>Agenda de Atendimentos</h3></div>
    <div class="card-body"><div id='calendar'></div></div>
</div>

<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="scheduleModalLabel">Novo Agendamento</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="modal-form-content">
            <form id="scheduleForm">
                <input type="hidden" id="start_datetime">
                <div class="mb-3"><label for="patientSelect" class="form-label">Paciente</label><select class="form-select" id="patientSelect" required></select></div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label for="locationInput" class="form-label">Local</label><input type="text" class="form-control" id="locationInput" value="Clínica"></div>
                    <div class="col-md-6 mb-3"><label for="priceInput" class="form-label">Preço da Sessão (R$)</label><input type="number" class="form-control" id="priceInput" placeholder="Ex: 150.00" step="0.01"></div>
                </div>
                <div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="isRecurringCheck"><label class="form-check-label" for="isRecurringCheck">Repetir atendimento</label></div>
                <div id="recurrenceOptions" class="border p-3 rounded mb-3" style="display: none;">
                    <div class="mb-3"><label class="form-label">Repetir nos dias:</label><div>
                        <div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="1" id="checkMon"><label class="form-check-label" for="checkMon">Seg</label></div>
                        <div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="2" id="checkTue"><label class="form-check-label" for="checkTue">Ter</label></div>
                        <div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="3" id="checkWed"><label class="form-check-label" for="checkWed">Qua</label></div>
                        <div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="4" id="checkThu"><label class="form-check-label" for="checkThu">Qui</label></div>
                        <div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="5" id="checkFri"><label class="form-check-label" for="checkFri">Sex</label></div>
                        <div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="6" id="checkSat"><label class="form-check-label" for="checkSat">Sáb</label></div>
                    </div></div>
                    <div class="mb-3"><label for="weeksRepeatInput" class="form-label">Por quantas semanas?</label><input type="number" class="form-control" id="weeksRepeatInput" value="4" min="1"></div>
                </div>
                <div class="mb-3"><label for="notesTextarea" class="form-label">Anotações (Geral)</label><textarea class="form-control" id="notesTextarea" rows="2"></textarea></div>
            </form>
        </div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" id="saveAppointmentBtn">Salvar</button></div>
    </div>
  </div>
</div>

<div class="modal fade" id="viewEventModal" tabindex="-1" aria-labelledby="viewEventModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="viewEventModalLabel">Detalhes do Agendamento</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
          <div class="row">
              <div class="col-md-7">
                  <h5 id="viewPatientName"></h5>
                  <p><i class="bi bi-calendar-event"></i> <span id="viewEventDate"></span></p>
                  <p><i class="bi bi-geo-alt"></i> <span id="viewEventLocation"></span></p>
                  <p><strong>Status:</strong> <span class="badge" id="viewEventStatus"></span></p>
                  <hr>
                  <fieldset id="financialsFieldset">
                      <h6>Financeiro da Sessão</h6>
                      <div class="row">
                          <div class="col-6 mb-3"><label for="viewEventPrice" class="form-label">Preço da Sessão (R$)</label><input type="number" class="form-control" id="viewEventPrice" step="0.01"></div>
                          <div class="col-6 mb-3"><label for="viewAmountPaid" class="form-label">Valor Pago (R$)</label><input type="number" class="form-control" id="viewAmountPaid" step="0.01"></div>
                      </div>
                      <div class="mb-3"><label for="viewPaymentNotes" class="form-label">Anotações do Pagamento</label><textarea class="form-control" id="viewPaymentNotes" rows="2" placeholder="Ex: Pagamento via Pix referente a 2 sessões"></textarea></div>
                  </fieldset>
              </div>
              <div class="col-md-5 border-start">
                  <h6>Balanço Financeiro do Paciente</h6>
                  <div id="patient-balance-details">
                      <p class="mb-1">Total Cobrado: <span id="balanceTotalDue"></span></p>
                      <p class="mb-1">Total Pago: <span id="balanceTotalPaid"></span></p>
                      <hr class="my-2">
                      <p class="fs-5 mb-0"><strong>Saldo: <span id="balanceTotalBalance"></span></strong></p>
                  </div>
              </div>
          </div>
      </div>
      <div class="modal-footer justify-content-between">
          <div>
              <button type="button" class="btn btn-outline-danger btn-sm" id="cancelAppointmentTriggerBtn"><i class="bi bi-x-circle"></i> Cancelar Atendimento</button>
              <a href="#" id="viewGoToPatient" class="btn btn-outline-info btn-sm">Ver Prontuário Completo</a>
          </div>
          <div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            <button type="button" class="btn btn-primary" id="saveFinancialsBtn">Salvar Alterações</button>
          </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="cancelConfirmationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Confirmar Cancelamento</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <p>Tem a certeza que deseja cancelar este atendimento?</p>
        <p class="text-danger small">Esta ação não pode ser desfeita.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
        <button type="button" class="btn btn-danger" id="confirmCancelBtn">Sim, cancelar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}


{% block scripts %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- INICIALIZAÇÃO ---
    var calendarEl = document.getElementById('calendar');
    var scheduleModal = new bootstrap.Modal(document.getElementById('scheduleModal'));
    var viewEventModal = new bootstrap.Modal(document.getElementById('viewEventModal'));
    var cancelConfirmationModal = new bootstrap.Modal(document.getElementById('cancelConfirmationModal'));
    let currentEventId = null;

    const formatCurrency = (value) => `R$ ${(value || 0).toFixed(2).replace('.', ',')}`;

    // --- CONFIGURAÇÃO DO CALENDÁRIO ---
    var calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'pt-br',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
        initialView: 'timeGridWeek',
        events: '/api/appointments',
        selectable: true,

        eventClassNames: function(arg) {
            return arg.event.extendedProps.status === 'Cancelado' ? ['cancelled-event'] : [];
        },
        eventContent: function(arg) {
            let props = arg.event.extendedProps;
            let balance = (props.amount_paid || 0) - (props.session_price || 0);
            let iconHtml = '';
            if (props.session_price > 0 && props.status !== 'Cancelado') {
                let iconClass = balance >= 0 ? 'bi-check-circle-fill' : 'bi-exclamation-circle-fill';
                let paymentClass = balance >= 0 ? 'payment-balance-positive' : 'payment-balance-negative';
                if (balance === 0) paymentClass = 'payment-balance-zero';
                if (balance === 0 && props.amount_paid > 0) paymentClass = 'payment-balance-positive';
                iconHtml = `<span class="payment-icon ${paymentClass}" title="Balanço: ${formatCurrency(balance)}"><i class="bi ${iconClass}"></i></span>`;
            }
            return { html: `<div class="fc-event-title">${arg.event.title}</div>${iconHtml}` };
        },
        dateClick: function(info) {
            document.getElementById('scheduleForm').reset();
            document.getElementById('recurrenceOptions').style.display = 'none';
            document.getElementById('start_datetime').value = info.date.toISOString();
            document.getElementById('scheduleModalLabel').textContent = `Novo Agendamento em ${info.date.toLocaleDateString('pt-BR')} às ${info.date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}`;
            fetch('/api/patients').then(res => res.json()).then(patients => {
                let patientSelect = document.getElementById('patientSelect');
                patientSelect.innerHTML = ''; patientSelect.appendChild(new Option('-- Selecione --', ''));
                patients.forEach(p => patientSelect.appendChild(new Option(p.name, p.id)));
            });
            scheduleModal.show();
        },
        eventClick: function(info) {
            currentEventId = info.event.id;
            let props = info.event.extendedProps;
            let startDate = info.event.start;
            
            document.getElementById('viewPatientName').textContent = info.event.title;
            document.getElementById('viewEventDate').textContent = startDate.toLocaleString('pt-BR', { dateStyle: 'full', timeStyle: 'short' });
            document.getElementById('viewEventLocation').textContent = props.location || 'N/A';
            document.getElementById('viewGoToPatient').href = `/patient/${props.patient_id}`;
            document.getElementById('viewEventPrice').value = props.session_price || '';
            document.getElementById('viewAmountPaid').value = props.amount_paid || '';
            document.getElementById('viewPaymentNotes').value = props.payment_notes || '';
            
            const statusBadge = document.getElementById('viewEventStatus');
            statusBadge.textContent = props.status;
            statusBadge.className = 'badge';
            if (props.status === 'Cancelado') statusBadge.classList.add('bg-secondary');
            else if (props.status === 'Concluído') statusBadge.classList.add('bg-success');
            else statusBadge.classList.add('bg-info');

            const isCancelled = props.status === 'Cancelado';
            document.getElementById('financialsFieldset').disabled = isCancelled;
            document.getElementById('saveFinancialsBtn').disabled = isCancelled;
            document.getElementById('cancelAppointmentTriggerBtn').disabled = isCancelled;
            
            fetchPatientBalance(props.patient_id);
            viewEventModal.show();
        }
    });
    calendar.render();

    // --- FUNÇÕES AUXILIARES ---
    function fetchPatientBalance(patientId) {
        fetch(`/api/patient/${patientId}/financial_balance`).then(res => res.json()).then(data => {
            document.getElementById('balanceTotalDue').textContent = formatCurrency(data.total_due);
            document.getElementById('balanceTotalPaid').textContent = formatCurrency(data.total_paid);
            let balanceSpan = document.getElementById('balanceTotalBalance');
            balanceSpan.textContent = formatCurrency(data.balance);
            balanceSpan.className = data.balance < 0 ? 'text-danger' : 'text-success';
        });
    }

    function sendApiRequest(url, data) {
        return fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    }

    // --- EVENT LISTENERS DOS BOTÕES ---
    document.getElementById('isRecurringCheck').addEventListener('change', function() {
        document.getElementById('recurrenceOptions').style.display = this.checked ? 'block' : 'none';
    });

    document.getElementById('saveAppointmentBtn').addEventListener('click', function() {
        let appointmentData = {
            patient_id: document.getElementById('patientSelect').value,
            start_datetime: document.getElementById('start_datetime').value,
            location: document.getElementById('locationInput').value,
            session_price: document.getElementById('priceInput').value,
            notes: document.getElementById('notesTextarea').value,
            is_recurring: document.getElementById('isRecurringCheck').checked,
            weekdays: Array.from(document.querySelectorAll('.weekday-check:checked')).map(cb => cb.value),
            weeks_to_repeat: document.getElementById('weeksRepeatInput').value
        };
        if (!appointmentData.patient_id) return alert('Selecione um paciente.');
        
        sendApiRequest('/api/appointment/create_from_agenda', appointmentData)
            .then(res => res.json()).then(data => {
                if (data.status === 'success') { scheduleModal.hide(); calendar.refetchEvents(); }
                else { alert(`Erro ao salvar: ${data.message}`); }
            });
    });

    document.getElementById('saveFinancialsBtn').addEventListener('click', function() {
        const financialData = { session_price: document.getElementById('viewEventPrice').value, amount_paid: document.getElementById('viewAmountPaid').value, payment_notes: document.getElementById('viewPaymentNotes').value };
        sendApiRequest(`/api/appointment/${currentEventId}/update_financials`, financialData)
            .then(res => res.json()).then(data => {
                if (data.status === 'success') { viewEventModal.hide(); calendar.refetchEvents(); }
                else { alert(`Erro ao salvar: ${data.message}`); }
            });
    });

    document.getElementById('cancelAppointmentTriggerBtn').addEventListener('click', function() {
        cancelConfirmationModal.show();
    });

    document.getElementById('confirmCancelBtn').addEventListener('click', function() {
        if (!currentEventId) return;
        sendApiRequest(`/api/appointment/${currentEventId}/cancel`, {})
            .then(res => res.json()).then(data => {
                if (data.status === 'success') {
                    cancelConfirmationModal.hide();
                    viewEventModal.hide();
                    calendar.refetchEvents();
                } else { alert(`Erro ao cancelar: ${data.message}`); }
            });
    });
});
</script>
{% endblock %}