{% extends "base.html" %}

{% block styles %}
<style>
    /* ... (todos os estilos anteriores, sem alterações) ... */
    .fc-event-main-frame { display: flex; align-items: center; }
    .payment-icon { margin-left: 8px; font-size: 0.9em; padding: 2px 5px; border-radius: 4px; color: white; }
    .payment-balance-positive { background-color: #198754; }
    .payment-balance-negative { background-color: #dc3545; }
    .payment-balance-zero { background-color: #6c757d; }
    .fc-event.cancelled-event { background-color: #f8f9fa !important; border-color: #d3d3d3 !important; }
    .fc-event.cancelled-event .fc-event-title { text-decoration: line-through; color: #6c757d !important; }
    .fc-event.completed-event .fc-event-title { font-weight: bold; }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header"><h3>Agenda de Atendimentos</h3></div>
    <div class="card-body"><div id='calendar'></div></div>
</div>

<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="scheduleModalLabel">Novo Agendamento</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="scheduleForm">
            <div class="mb-3"><label for="patientSelect" class="form-label">Paciente</label><select class="form-select" id="patientSelect" required></select></div>
            
            <div class="row">
                <div class="col-md-7 mb-3"><label for="dateInput" class="form-label">Data</label><input type="date" class="form-control" id="dateInput"></div>
                <div class="col-md-5 mb-3"><label for="timeInput" class="form-label">Hora</label><input type="time" class="form-control" id="timeInput" step="1800"></div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3"><label for="locationInput" class="form-label">Local</label><input type="text" class="form-control" id="locationInput" value="Clínica"></div>
                <div class="col-md-6 mb-3"><label for="priceInput" class="form-label">Preço da Sessão (R$)</label><input type="number" class="form-control" id="priceInput" placeholder="Ex: 150.00" step="0.01"></div>
            </div>

            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="isRecurringCheck">
                <label class="form-check-label" for="isRecurringCheck">Repetir atendimento</label>
            </div>
            <div id="recurrenceOptions" class="border p-3 rounded mb-3" style="display: none;">
                <div class="mb-3"><label class="form-label">Repetir nos dias:</label><div>
                    <div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="1" id="checkMon"><label for="checkMon">Seg</label></div>
                    <div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="2" id="checkTue"><label for="checkTue">Ter</label></div>
                    <div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="3" id="checkWed"><label for="checkWed">Qua</label></div>
                    <div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="4" id="checkThu"><label for="checkThu">Qui</label></div>
                    <div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="5" id="checkFri"><label for="checkFri">Sex</label></div>
                    <div class="form-check form-check-inline"><input class="form-check-input weekday-check" type="checkbox" value="6" id="checkSat"><label for="checkSat">Sáb</label></div>
                </div></div>
                <div class="mb-3"><label for="weeksRepeatInput" class="form-label">Por quantas semanas?</label><input type="number" class="form-control" id="weeksRepeatInput" value="4" min="1"></div>
            </div>
            <div class="mb-3"><label for="notesTextarea" class="form-label">Anotações</label><textarea class="form-control" id="notesTextarea" rows="2"></textarea></div>
        </form>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button><button type="button" class="btn btn-primary" id="saveAppointmentBtn">Salvar</button></div>
    </div>
  </div>
</div>

<div class="modal fade" id="viewEventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="viewEventModalLabel">Detalhes do Agendamento</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="editEventForm"><h5 id="viewPatientName"></h5><fieldset id="general-fieldset" disabled><div class="row"><div class="col-md-7 mb-3"><label for="viewEventDateInput" class="form-label">Data e Hora</label><input type="datetime-local" class="form-control" id="viewEventDateInput"></div><div class="col-md-5 mb-3"><label for="viewEventLocationInput" class="form-label">Local</label><input type="text" class="form-control" id="viewEventLocationInput"></div></div><div class="mb-3"><label for="viewEventNotes" class="form-label">Anotações Gerais</label><textarea class="form-control" id="viewEventNotes" rows="2"></textarea></div></fieldset><hr><fieldset id="financialsFieldset" disabled><h6>Financeiro da Sessão</h6><div class="row"><div class="col-6 mb-3"><label for="viewEventPrice" class="form-label">Preço da Sessão (R$)</label><input type="number" class="form-control" id="viewEventPrice" step="0.01"></div><div class="col-6 mb-3"><label for="viewAmountPaid" class="form-label">Valor Pago (R$)</label><input type="number" class="form-control" id="viewAmountPaid" step="0.01"></div></div><div class="mb-3"><label for="viewPaymentNotes" class="form-label">Anotações do Pagamento</label><textarea class="form-control" id="viewPaymentNotes" rows="2"></textarea></div></fieldset></form></div><div class="modal-footer justify-content-between"><div><button type="button" class="btn btn-outline-danger btn-sm" id="deleteAppointmentTriggerBtn" title="Apagar Permanentemente"><i class="bi bi-trash"></i></button> <a href="#" id="viewGoToPatient" class="btn btn-outline-info btn-sm">Ver Prontuário</a></div><div><button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeViewBtn">Fechar</button><button type="button" class="btn btn-outline-secondary" id="editAppointmentBtn">Editar</button><button type="button" class="btn btn-primary" id="saveChangesBtn" style="display:none;">Salvar Alterações</button><button type="button" class="btn btn-outline-warning" id="cancelAppointmentTriggerBtn">Cancelar Atendimento</button><button type="button" class="btn btn-outline-success" id="completeAppointmentBtn">Marcar como Concluído</button></div></div></div></div>
</div>

<div class="modal fade" id="cancelConfirmationModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Confirmar Cancelamento</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Tem a certeza que deseja marcar este atendimento como 'Cancelado'?</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button><button type="button" class="btn btn-warning" id="confirmCancelBtn">Sim, marcar como cancelado</button></div></div></div></div>
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle-fill"></i> Confirmar Exclusão Permanente</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Tem a certeza absoluta que deseja <strong>apagar</strong> este atendimento?</p><p class="text-danger"><strong>Atenção:</strong> Esta ação é irreversível.</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button><button type="button" class="btn btn-danger" id="confirmDeleteBtn">Sim, apagar</button></div></div></div></div>
{% endblock %}


{% block scripts %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- INICIALIZAÇÃO ---
    var scheduleModal = new bootstrap.Modal(document.getElementById('scheduleModal'));
    var viewEventModal = new bootstrap.Modal(document.getElementById('viewEventModal'));
    var cancelConfirmationModal = new bootstrap.Modal(document.getElementById('cancelConfirmationModal'));
    var deleteConfirmationModal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
    let currentEventId = null;

    // --- CONFIGURAÇÃO DO CALENDÁRIO ---
    var calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        locale: 'pt-br',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
        initialView: 'timeGridWeek',
        events: '/api/appointments',
        selectable: true,
        
        // ATUALIZADO: Lógica do clique para criar agendamento
        dateClick: function(info) {
            document.getElementById('scheduleForm').reset();
            document.getElementById('recurrenceOptions').style.display = 'none';

            const clickedDate = info.date;
            
            // Separa data e hora
            const dateStr = clickedDate.getFullYear() + '-' + String(clickedDate.getMonth() + 1).padStart(2, '0') + '-' + String(clickedDate.getDate()).padStart(2, '0');
            const timeStr = String(clickedDate.getHours()).padStart(2, '0') + ':' + String(clickedDate.getMinutes()).padStart(2, '0');
            
            // Preenche os novos campos de data e hora
            document.getElementById('dateInput').value = dateStr;
            document.getElementById('timeInput').value = timeStr;

            document.getElementById('scheduleModalLabel').textContent = `Novo Agendamento`;
            
            // Busca pacientes e mostra o modal
            fetch('/api/patients').then(res => res.json()).then(patients => {
                let patientSelect = document.getElementById('patientSelect');
                patientSelect.innerHTML = ''; 
                patientSelect.appendChild(new Option('-- Selecione --', ''));
                patients.forEach(p => patientSelect.appendChild(new Option(p.name, p.id)));
            });
            scheduleModal.show();
        },

        // Lógica de clicar em evento existente (sem alterações)
        eventClick: function(info) {
            // ... (o código daqui permanece o mesmo da versão anterior)
            currentEventId = info.event.id;
            let props = info.event.extendedProps;
            setViewMode(false, props.status);
            document.getElementById('viewPatientName').textContent = info.event.title;
            const localDateTime = new Date(info.event.start.getTime() - (info.event.start.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('viewEventDateInput').value = localDateTime;
            document.getElementById('viewEventLocationInput').value = props.location || '';
            document.getElementById('viewEventNotes').value = props.notes || '';
            document.getElementById('viewGoToPatient').href = `/patient/${props.patient_id}`;
            document.getElementById('viewEventPrice').value = props.session_price || '';
            document.getElementById('viewAmountPaid').value = props.amount_paid || '';
            document.getElementById('viewPaymentNotes').value = props.payment_notes || '';
            fetchPatientBalance(props.patient_id);
            viewEventModal.show();
        }
        // ... (outras configurações do calendário como eventClassNames, eventContent)
    });
    calendar.render();

    // --- EVENT LISTENERS DOS BOTÕES ---

    // Botão SALVAR NOVO agendamento (ATUALIZADO)
    document.getElementById('saveAppointmentBtn').addEventListener('click', function() {
        const dateValue = document.getElementById('dateInput').value;
        const timeValue = document.getElementById('timeInput').value;
        // Combina data e hora para criar a string ISO 8601
        const startDateTime = new Date(`${dateValue}T${timeValue}`).toISOString();

        let appointmentData = {
            patient_id: document.getElementById('patientSelect').value,
            start_datetime: startDateTime, // Usa o valor combinado
            location: document.getElementById('locationInput').value,
            session_price: document.getElementById('priceInput').value,
            notes: document.getElementById('notesTextarea').value,
            is_recurring: document.getElementById('isRecurringCheck').checked,
            weekdays: Array.from(document.querySelectorAll('.weekday-check:checked')).map(cb => cb.value),
            weeks_to_repeat: document.getElementById('weeksRepeatInput').value
        };
        if (!appointmentData.patient_id) return alert('Selecione um paciente.');
        
        fetch('/api/appointment/create_from_agenda', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(appointmentData),
        }).then(res => res.json()).then(data => {
            if (data.status === 'success') { scheduleModal.hide(); calendar.refetchEvents(); } 
            else { alert(`Erro ao salvar: ${data.message}`); }
        });
    });
    
    // ... (todos os outros listeners e funções auxiliares permanecem iguais) ...
    document.getElementById('isRecurringCheck').addEventListener('change', function() { document.getElementById('recurrenceOptions').style.display = this.checked ? 'block' : 'none'; });
    document.getElementById('editAppointmentBtn').addEventListener('click', function() { setViewMode(true); });
    document.getElementById('saveChangesBtn').addEventListener('click', function() {
        // ... lógica de salvar alterações ...
    });
    document.getElementById('cancelAppointmentTriggerBtn').addEventListener('click', function() { cancelConfirmationModal.show(); });
    document.getElementById('confirmCancelBtn').addEventListener('click', function() { performAction('cancel'); });
    document.getElementById('deleteAppointmentTriggerBtn').addEventListener('click', function() { deleteConfirmationModal.show(); });
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() { performAction('delete'); });
    document.getElementById('completeAppointmentBtn').addEventListener('click', function() { performAction('complete'); });
});
</script>
{% endblock %}